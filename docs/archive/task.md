# nowtask UI復活タスクリスト - 最優先事項

## 📋 現状分析

**問題:** Androidスマホで現在のUIが崩壊しており、OLDのUIと同じように使用できない

**調査結果（フェーズ1完了）:**
- HTML: OLD版と現在版は完全に同一 ✓
- CSS: OLD版と現在版は完全に同一 ✓
- **JavaScript:** 全14ファイル比較完了 - 全て完全に同一（末尾改行の差異のみ） ✓
- **Firebase設定:** firebase-init.js は完全に同一 ✓

## 🔍 **根本原因を特定しました！**

**問題の原因:**
Android アプリの `android-app/app/src/main/assets/index.html` に、**auth.js の読み込みが欠けています**。

### 詳細な分析:

1. **auth.js ファイルの存在確認:**
   - ✅ `android-app/app/src/main/assets/js/auth.js` - **存在する**
   - ❌ ルートディレクトリの `js/auth.js` - **存在しない**
   - ❌ OLD ディレクトリの `OLD/js/auth.js` - **存在しない**

2. **auth.js の役割:**
   - Android ネイティブブリッジ (`AndroidAuth`, `FirestoreBridge`) との連携
   - ログイン状態の管理
   - メイン画面とログイン画面の切り替え (`showLogin()`, `showMainApp()`)
   - 初期化関数 `initAuth()` と `checkLoginState()`

3. **UI 崩壊の原因:**
   - Android アプリの index.html で auth.js が読み込まれていない
   - `checkLoginState()` が実行されず、UI の初期化が正常に行われない
   - ログイン画面とメイン画面の表示切り替えが機能しない
   - DOM 要素（`.main-content`, `#create-task-btn` など）の表示制御が行われない

4. **検証した JavaScript ファイル（全て同一）:**
   - core.js, ui-main.js, events.js, render.js, tasks.js, modals.js, gauge.js
   - firebase-init.js, analytics.js, share.js, calendar.js
   - templates.js, overload.js, migration.js

## 🎯 UI復活のための詳細タスク

### ✅ フェーズ1: 問題箇所の特定 (完了)

- [x] **タスク1.1: JavaScriptファイルの比較** ✅ 完了
  - [x] OLD/js/core.js と js/core.js を比較 - 同一
  - [x] OLD/js/ui-main.js と js/ui-main.js を比較 - 同一
  - [x] OLD/js/events.js と js/events.js を比較 - 同一
  - [x] OLD/js/render.js と js/render.js を比較 - 同一
  - [x] OLD/js/tasks.js と js/tasks.js を比較 - 同一
  - [x] OLD/js/modals.js と js/modals.js を比較 - 同一
  - [x] OLD/js/gauge.js と js/gauge.js を比較 - 同一

- [x] **タスク1.2: Firebaseファイルの比較** ✅ 完了
  - [x] OLD/js/firebase-init.js と js/firebase-init.js を比較 - 同一
  - [x] 残りの JS ファイル比較完了 - 全て同一

- [x] **タスク1.3: Android アプリの設定確認** ✅ 完了
  - [x] Android アプリの index.html を確認
  - [x] **問題発見:** auth.js の読み込みが欠けている

### ✅ フェーズ2: 修正実装 (完了)

**解決策1:** Android アプリの index.html に auth.js を追加する

- [x] **タスク2.1: auth.js の読み込みを追加** ✅ 完了
  - [x] `android-app/app/src/main/assets/index.html` を編集
  - [x] スクリプトタグのセクション（行495）に以下を追加完了:
    ```html
    <script src="js/auth.js?v=33"></script>
    ```
  - [x] 追加位置: `ui-main.js` の後、`migration.js` の前 (行495)
  - [x] 変更内容を確認済み

**解決策2:** 空のstyle.cssファイル問題を修正

- [x] **タスク2.2: style.css が空であることを発見** ✅ 完了
  - [x] 問題: `android-app/app/src/main/assets/style.css` が0行（空）だった
  - [x] 原因: モーダルの `display: none` やSVGスタイル、ゲージスタイルが全て読み込まれていなかった
  - [x] ルートディレクトリの `style.css` (3051行) を android-app にコピー完了

**解決策3:** 不要な migration.js を無効化

- [x] **タスク2.3: migration.js をコメントアウト** ✅ 完了
  - [x] 問題: migration.js が緑色の📦ボタンを画面右下に表示していた
  - [x] `<script src="js/migration.js?v=33"></script>` をコメントアウト完了

**解決策4:** auth.js が初期化を妨げる問題を修正

- [x] **タスク2.4: auth.js をコメントアウト** ✅ 完了
  - [x] 問題: auth.js が `FirestoreBridge` と `AndroidAuth` を待ち続けて初期化が止まる
  - [x] 症状: ヘッダーとタスク入力は表示されるが、それ以外が一色で何も表示されない
  - [x] `<script src="js/auth.js?v=33"></script>` をコメントアウト完了
  - [x] これで OLD バージョンと同じスクリプト構成になった

### ✅ フェーズ3: 動作確認 (スキップ - 基本動作OK)

基本的な表示と動作は確認済み。次のフェーズに進む。

---

## 🚀 今後の開発フェーズ

### ✅ フェーズ4: ログイン機構の実装（完了）

**目的:** 完全なログイン機能の実装とユーザーデータの安全な管理

**状態:** ✅ Phase 4 完了！Google認証とデータ同期が完全に動作中

#### 4.1: Google認証システムの構築 ✅
- [x] **タスク4.1.1: AndroidAuth.ktのGoogle認証実装**
  - [x] Google Sign-In APIの統合テスト
  - [x] トークン取得と検証処理
  - [x] 認証状態の永続化
  - [x] エラーハンドリング（ネットワークエラー、キャンセル等）
  - [x] 匿名ユーザーの `linkWithCredential()` による移行

- [x] **タスク4.1.2: auth.jsの再有効化と修正**
  - [x] auth.jsのコメント解除
  - [x] AndroidAuthブリッジとの連携確認
  - [x] checkLoginState()の動作確認
  - [x] ログイン/ログアウトフローのテスト

- [x] **タスク4.1.3: ログインUI/UXの実装**
  - [x] ログイン画面のデザイン
  - [x] Googleログインボタンの実装
  - [x] ログイン中の読み込み表示
  - [x] ログイン成功/失敗時のフィードバック

#### 4.2: 匿名ユーザーから正式ユーザーへの移行 ✅
- [x] **タスク4.2.1: データ移行フローの実装**
  - [x] 匿名ユーザーのデータ保存確認
  - [x] Google認証後のデータマージ処理（linkWithCredential使用）
  - [x] 移行時のエラーハンドリング
  - [x] データキャッシュ方式によるスムーズな転送

- [x] **タスク4.2.2: 移行UI/UXの設計**
  - [x] アカウント連携の自動化（linkWithCredential）
  - [x] データ移行はシームレス（uidが変わらないため）
  - [x] ログイン完了の確認メッセージ

#### 4.3: ログアウトとアカウント管理 ✅
- [x] **タスク4.3.1: ログアウト機能**
  - [x] ログアウト処理の実装
  - [x] ローカルデータのクリア
  - [x] 確認ダイアログの実装（モーダル重なり順序の問題を修正）
  - [x] ログアウト後の画面遷移（匿名モードに戻る）

- [x] **タスク4.3.2: アカウント情報表示**
  - [x] デフォルトアイコンの表示
  - [x] ユーザー名・メールアドレスの表示
  - [x] アカウント設定画面の実装

#### 4.4: データ転送の問題解決 ✅
- [x] **タスク4.4.1: evaluateJavascript()の文字列長制限問題**
  - [x] 問題の特定: 長いJSONデータが破損する
  - [x] Base64エンコードを試みるも失敗
  - [x] **解決策**: データキャッシュ方式を実装
    - Kotlin側でMapにキャッシュ
    - JavaScript側で同期的に取得
  - [x] 詳細レポート: `docs/ok2.md`

**Phase 4 の成果:**
- ✅ Google認証が正常に動作
- ✅ 匿名ユーザーからの移行がスムーズ
- ✅ ログイン後にタスクが正しく表示される
- ✅ ログアウト機能が正常に動作
- ✅ データ同期が完全に機能

**修正ファイル（v=37）:**
- `WebAppInterface.kt`: データキャッシュ方式の実装
- `firebase-init.js`: getCachedData()呼び出し
- `auth.js`: ログアウトボタンのモーダル重なり順序修正
- `index.html`: バージョンをv=37に更新

---

### 📱 フェーズ5: Androidネイティブ機能の実装

**目的:** WebViewラッパーからネイティブアプリへの段階的移行

#### ✅ 5.1: データ永続化のネイティブ実装（完了）
- [x] **タスク5.1.1: Firestore直接アクセスの実装** ✅
  - [x] FirestoreBridge.ktをより堅牢に実装
  - [x] オフラインキャッシュ機能の追加（ConcurrentHashMap）
  - [x] データ同期エラーのハンドリング改善（最大3回リトライ）
  - [x] ネットワーク状態の監視と自動再接続（NetworkMonitor実装）

- [x] **タスク5.1.2: ローカルデータベースの検討** ✅
  - [x] Room Databaseの導入完了（KSP使用）
  - [x] オフライン時の完全動作保証
  - [x] Firestoreとの双方向同期メカニズム実装

**Phase 5.1 の成果:**
- ✅ Room Database統合完了（Entity, DAO, AppDatabase実装）
- ✅ FirestoreとRoomの双方向同期機能実装
- ✅ 完全なオフライン対応（保存・読み込み・自動同期）
- ✅ 同期状態の追跡（SYNCED, PENDING, SYNCING, FAILED）
- ✅ kapt → KSP移行（Java 21対応、ビルド高速化）
- ✅ ビルド成功、動作確認OK

**実装ファイル:**
- `FirestoreBridge.kt`: Room統合、双方向同期、オフライン対応
- `KeyValueEntity.kt`: Room Entity定義
- `KeyValueDao.kt`: Database Access Object
- `AppDatabase.kt`: Room Database本体
- `NetworkUtils.kt`: ネットワーク監視機能
- `MainActivity.kt`: NetworkMonitor統合
- `build.gradle`: Kotlin 1.9.20、KSP導入

#### ✅ 5.2: 通知機能の実装（基本機能完了）
- [x] **タスク5.2.1: ローカル通知の実装** ✅
  - [x] WorkManagerの導入
  - [x] タスク期限前のリマインダー通知（期限1時間前、15分ごとにチェック）
  - [x] 通知チャンネルの作成
  - [x] 通知権限のリクエスト（Android 13以降）
  - [ ] 通知設定画面の実装（後回し）
  - [ ] 通知のカスタマイズ機能（後回し）

**Phase 5.2.1 の成果:**
- ✅ WorkManager統合完了（15分ごとの定期実行）
- ✅ TaskReminderWorker実装（Room Databaseからタスクを取得）
- ✅ NotificationHelper実装（通知の表示・キャンセル）
- ✅ 期限1時間前に通知を送信
- ✅ 重複通知の防止（24時間以内は1回のみ）
- ✅ ビルド成功、動作確認OK

**実装ファイル:**
- `NotificationHelper.kt`: 通知管理ヘルパークラス
- `TaskReminderWorker.kt`: 定期実行ワーカー
- `MainActivity.kt`: WorkManagerスケジューリング
- `AndroidManifest.xml`: POST_NOTIFICATIONS権限追加
- `build.gradle`: WorkManager依存関係追加

- [ ] **タスク5.2.2: プッシュ通知の準備**（将来的に）
  - [ ] Firebase Cloud Messagingの統合準備
  - [ ] 将来的な共有機能やチーム機能への布石

#### ✅ 5.3: ウィジェット機能（完全実装完了）
- [x] **タスク5.3.1: ホーム画面ウィジェット** ✅
  - [x] 今日のタスク一覧ウィジェット
  - [x] 24時間ゲージウィジェット
  - [x] ウィジェットからのクイックタスク追加

**Phase 5.3 の成果:**
- ✅ タスク一覧ウィジェット完全実装
  - 角丸デザイン（16dp）
  - タスク名と時刻表示（開始-終了）
  - ウィジェット全体タップでアプリ起動
  - クイックタスク追加ボタン（+）
- ✅ 24時間ゲージウィジェット完全実装
  - 現在時刻表示
  - 24時間ゲージ（経過時間・予定時間の可視化）
  - 空き時間の表示
  - 時刻ラベル（0:00, 6:00, 12:00, 18:00, 24:00）
- ✅ クイックタスク追加機能
  - ダイアログ形式のタスク追加画面
  - タスク名、開始・終了時刻の入力
  - 保存後に自動でウィジェット更新
- ✅ データ構造の整合性確保
  - `dueDate`, `isCompleted`, `title`の正しい使用
  - ISO形式の日時パース対応
  - `startTime`-`endTime`表示形式

**実装ファイル:**
- `widget_task_list.xml`: タスクウィジェットレイアウト（角丸対応）
- `widget_gauge.xml`: 24時間ゲージウィジェットレイアウト
- `widget_background.xml`: 角丸背景drawable
- `widget_info.xml`: タスクウィジェット設定
- `widget_gauge_info.xml`: ゲージウィジェット設定
- `TaskWidgetProvider.kt`: タスクウィジェットプロバイダー
- `GaugeWidgetProvider.kt`: ゲージウィジェットプロバイダー
- `QuickAddTaskActivity.kt`: クイックタスク追加画面
- `activity_quick_add_task.xml`: タスク追加レイアウト
- `AndroidManifest.xml`: 両ウィジェットとActivity登録
- `strings.xml`: ウィジェット説明文追加

---

### 🎨 フェーズ6: UI/UX の改善と最適化

**目的:** ユーザビリティの向上と操作性の改善（モノクロデザインを維持）

#### 6.1: タッチ操作とジェスチャーの最適化
- [x] **タスク6.1.1: スワイプジェスチャーの実装** ✅ (部分完了)
  - [x] 右スワイプ: タスク完了/未完了トグル
  - [x] 左スワイプ: タスク削除（確認ダイアログ表示）
  - [x] スワイプ中のビジュアルフィードバック（アイコン表示）
  - [x] スワイプ感度の調整とキャンセル機能（±15px中央キャンセルゾーン、30px閾値）

**実装済み機能:**
- 右スワイプ（80px移動）でタスク完了/未完了のトグル
- 左スワイプ（-80px移動）でタスク削除（確認ダイアログ付き）
- スワイプ中の視覚的フィードバック（✓アイコン・×アイコン表示）
- ±15pxの中央キャンセルゾーン（短い横移動で簡単にキャンセル可能）
- 長押し時間を1000msに延長（スワイプとの誤判定を防止）
- バイブレーションフィードバック
- スワイプ時の画面スクロール防止（preventDefault/stopPropagation）

**実装ファイル:**
- `style.css` (lines 847-903): スワイプアニメーションのCSS
- `render.js` (lines 668-1129): スワイプ検出とハンドラー実装

- [ ] **タスク6.1.2: 長押し操作の実装**
  - [ ] 長押しでコンテキストメニュー表示
  - [ ] メニュー項目: 編集、削除、複製、移動
  - [ ] 長押し中のハプティックフィードバック

- [ ] **タスク6.1.3: ドラッグ&ドロップの実装**
  - [ ] タスクの並び替え（同じ日付内）
  - [ ] ドラッグ中のビジュアルフィードバック
  - [ ] ドロップ位置のプレビュー表示

---

#### 🐛 6.1: 既知の問題（Known Issues）

##### **問題: 長押しドラッグによるタスクの意図しない移動**

**問題の詳細:**
- 今日のタスクを長押しして指を離すと、「期限なし」セクションに勝手に移動してしまう
- ユーザーの意図しないタスク移動が発生
- 特にMIUIランチャー（Xiaomi端末）で顕著に発生

**根本原因:**
1. **MIUIシステムの介入**
   - MIUI独自の`MiuiDragDropImpl`がタッチイベントを乗っ取る
   - 通常の`touchend`イベントではなく、`ACTION_CANCEL`が送信される
   - システムレベルのドラッグ処理が優先される

2. **タッチイベントフローの問題**
   ```
   通常: touchstart → touchmove → touchend
   MIUI: touchstart → touchmove → ACTION_CANCEL → MiuiDragDropImpl介入
   ```

3. **指の微小な動きの検出**
   - 長押し中の指の微小な動き（1-2px）がドラッグ開始と判定される
   - `isDragging = false`の状態でもMIUIが独自にドラッグを開始
   - `saveNewTaskOrder()`が意図せず呼び出される

**試した改善策（すべて失敗）:**

1. **`hasMoved`フラグの追加（50px閾値）**
   ```javascript
   let hasMoved = false;
   if (dragDistance > 50) {
     hasMoved = true;
   }
   ```
   - **失敗理由**: 長押し中の指の微小な動きが蓄積されて50pxを超えてしまう
   - ログ: `dragDistance: 67px`のような値が記録される

2. **`touchcancel`イベントハンドラーの追加**
   ```javascript
   element.addEventListener('touchcancel', (e) => {
     console.log('Touch cancelled by system');
     isDragging = false;
     renderTasks(); // 元の状態に戻す
   });
   ```
   - **失敗理由**: MIUIが`touchcancel`発火後も独自の処理を続行
   - `touchcancel`時点では`isDragging = false`だが、その後にMIUIが保存処理を実行

3. **`dragDistance`トラッキングの追加**
   ```javascript
   dragDistance += Math.abs(moveX) + Math.abs(moveY);
   ```
   - **失敗理由**: 長押し中の自然な指の揺れが距離として加算される
   - 意図しないドラッグとして判定されてしまう

4. **`saveNewTaskOrder()`にガード条件追加**
   ```javascript
   function saveNewTaskOrder() {
     if (!isDragging && !draggedElement) {
       console.log('BLOCKING SAVE');
       return;
     }
     // 保存処理...
   }
   ```
   - **失敗理由**: MIUIが別のコードパスから保存処理を呼び出している可能性
   - JavaScriptのガード条件をバイパスされる

5. **長押し時間の延長（500ms → 1000ms）**
   ```javascript
   longPressTimer = setTimeout(() => {
     isDragging = true;
   }, 1000);
   ```
   - **失敗理由**: 長押し時間を延ばしても、MIUIのシステム介入は防げない
   - ユーザー体験が悪化（反応が遅く感じる）

**ログからの観察:**
```
01:56:12.607 - ACTION_CANCEL detected
01:56:12.608 - touchcancel - isDragging: false, hasMoved: true, dragDistance: 67px
01:56:12.772 - MiuiDragDropImpl - Entering the native process
01:56:12.775 - Saving data to Firestore (意図しない保存)
```

**推奨される改善方法（今後の実装候補）:**

1. **ネイティブドラッグの完全無効化**
   ```kotlin
   // MainActivity.kt または WebViewのセットアップ
   webView.setOnDragListener { _, _ -> true } // すべてのドラッグイベントを消費
   ```

2. **ジェスチャーライブラリの導入**
   - Hammer.js や別のジェスチャーライブラリを使用
   - より高度なジェスチャー判定とMIUI対策

3. **明示的なドラッグボタンの追加**
   - タスクアイテムに「⋮⋮」（ドラッグハンドル）ボタンを追加
   - ボタン押下時のみドラッグ可能にする
   - 誤操作の防止

4. **長押しジェスチャーの代替**
   - 長押しではなくダブルタップやスワイプでコンテキストメニュー表示
   - MIUIのシステム介入を完全に回避

5. **WebView設定の見直し**
   ```kotlin
   webView.settings.apply {
     setSupportMultipleWindows(false)
     // その他のタッチイベント関連設定
   }
   ```

**現在のステータス: ⏸️ 保留中**
- 複数の対策を試みたが、MIUI固有の問題のため解決に至らず
- ネイティブコード側での対策が必要
- フェーズ6.1の他のタスクを優先し、後日再検討

---

#### 6.2: アニメーションと視覚的フィードバック
- [ ] **タスク6.2.1: スムーズな画面遷移**
  - [ ] モーダルのフェードイン/アウト（200ms）
  - [ ] スライドアニメーション（下から上へ）
  - [ ] タスク追加時のリストアニメーション
  - [ ] タスク削除時のフェードアウト効果

- [ ] **タスク6.2.2: マイクロインタラクション**
  - [ ] チェックボックスのチェックアニメーション
  - [ ] 完了タスクの打ち消し線アニメーション
  - [ ] FABボタンの回転/拡大効果
  - [ ] タップ時のリップルエフェクト強化

- [ ] **タスク6.2.3: ゲージのアニメーション**
  - [ ] 24時間ゲージの滑らかな更新（トランジション）
  - [ ] 密度変化時の色遷移アニメーション
  - [ ] 現在時刻マーカーの滑らかな移動

#### ✅ 6.3: 検索・フィルター・ソート機能の強化（完了）
- [x] **タスク6.3.1: 検索機能の実装** ✅ 完了
  - [x] タスク名・メモでの全文検索
  - [x] リアルタイム検索結果の表示
  - [x] 検索履歴の保存
  - [x] 検索結果のハイライト表示

- [x] **タスク6.3.2: 高度なフィルター機能** ✅ 完了
  - [x] 優先度フィルター（高・中・低）
  - [x] 期限フィルター（今日・明日・今週・期限切れ）
  - [x] 完了/未完了フィルター
  - [x] ルーティンタスクのフィルター
  - [x] 複数フィルターの組み合わせ

- [x] **タスク6.3.3: ソート機能の拡張** ✅ 完了
  - [x] 期限順（昇順/降順）
  - [x] 優先度順
  - [x] 作成日時順
  - [x] タスク名順（50音順/ABC順）
  - [x] ソート設定の永続化

**Phase 6.3 の成果:**
- ✅ search-filter.js完全実装（468行）
- ✅ 検索バー、フィルターボタン、ソートセレクトのUI実装
- ✅ リアルタイム検索とハイライト表示
- ✅ 検索履歴の保存と表示（最大10件）
- ✅ 12種類のフィルター（優先度・期限・状態）
- ✅ 6種類のソート順（時間・作成日・優先度・タスク名）
- ✅ ソート設定の永続化（localStorage）
- ✅ render.jsとの完全統合

**実装ファイル（v=42）:**
- `js/search-filter.js`: 検索・フィルター・ソート機能の実装
- `js/render.js`: ハイライト表示の統合
- `js/ui-main.js`: 初期化処理
- `index.html`: 検索バー、フィルターボタン、ソートセレクトのUI
- `style.css`: 検索・フィルター・ソートのスタイル

#### ✅ 6.4: バッチ操作と効率化機能（完了）

- [x] **タスク6.4.1: 複数選択モード** ✅ 完了
  - [x] 選択モードボタンで複数選択モードに移行
  - [x] チェックボックスでの複数選択
  - [x] 選択数の表示（"3個選択中"など）
  - [x] 全選択/全解除ボタン
  - [x] 複数選択ボタンの配置改善（24時間ゲージ下部に配置）

- [x] **タスク6.4.2: バッチ操作の実装** ✅ 完了
  - [x] 複数タスクの一括完了
  - [x] 複数タスクの一括削除（確認ダイアログ付き）
  - [x] 複数タスクの日付変更（今日/明日/来週/期限なし）
  - [x] 複数タスクの優先度変更（緊急/高/中/低/未設定）
  - [x] 操作前の確認ダイアログ

- [x] **タスク6.4.3: クイックアクション** ✅ 完了
  - [x] 今日のタスクを一括完了 (render.js:1838-1868)
  - [x] 期限切れタスクを明日に移動 (render.js:1873-1906)
  - [x] 完了タスクをアーカイブ (render.js:1911-1937)
  - [x] 未完了タスクを明日にコピー (render.js:1942-1989)

**Phase 6.4 UI改善（最新）:**
- ✅ 複数選択ボタンを24時間ゲージの下部、昨日以前のタスクの上部に配置
- ✅ ボタンデザイン: 白背景・黒枠（通常時）→ 黒背景・白文字（アクティブ時）
- ✅ ボタンクリックで複数選択モードON/OFF
- ✅ アクティブ状態の視覚的フィードバック（activeクラス）

**実装ファイル（最新）:**
- `index.html`: 複数選択ボタンのHTML追加（lines 128-137）
- `style.css`: 複数選択ボタンのスタイル追加（末尾に追加）
- `js/events.js`: 複数選択ボタンのイベントリスナー追加（lines 699-707）
- `js/render.js`: toggleSelectionMode()にボタンスタイル変更追加（lines 1531-1545）

#### ✅ 6.5: 入力体験の改善（完了）

**Phase 6.5 の成果:**
- ✅ `js/input-experience.js` (403行) 実装完了
- ✅ 自然言語日時解析（parseNaturalDatetime）：11日付パターン、3時刻形式対応
- ✅ テンプレートオートコンプリート：10テンプレート、最大5件提案
- ✅ タスク履歴サジェスト：最大10件表示
- ✅ 絵文字ピッカー：20個の一般的な絵文字
- ✅ HTML特殊文字エスケープ：XSS対策完備
- ✅ キーボード処理：フォーカス/ブラーイベント、scrollIntoView対応
- ✅ フォーム統合：自然言語解析結果のタスク作成への統合
- ✅ CSS スタイル：130+ 行（オートコンプリート、絵文字ピッカー）

**実装ファイル（v=48）:**
- `js/input-experience.js`: メイン実装（403行、12関数）
- `js/events.js`: クイック入力フォーム統合（lines 382-516改善）
- `style.css`: UI スタイル（lines 3642-3768）
- `index.html`: スクリプト読み込み（line 628）
- `docs/INPUT_EXPERIENCE_TESTING.md`: テストガイド（10テストケース）

**実装機能:**

- [x] **タスク6.5.1: スマート入力機能**
  - [x] 日時の自然言語入力（「明日 14時」など）
  - [x] 定型文の自動補完（買い物、会議準備など10個）
  - [x] タスク履歴からのサジェスト（最大10件）
  - [x] 絵文字ピッカーの統合（20個の絵文字）

- [x] **タスク6.5.2: フォーム入力の最適化**
  - [x] キーボード表示時の画面調整（scrollIntoView）
  - [x] Enterキーでの素早い保存（フォーム統合完了）
  - [x] フォーカス管理の改善（blur時にオートコンプリート非表示）
  - [x] 自然言語解析とのシームレス統合

- [x] **タスク6.5.3: テンプレート機能**
  - [x] よく使うタスク名のテンプレート（TEMPLATE_SNIPPETS）
  - [x] テンプレートからの素早い作成（オートコンプリート選択）
  - [x] テンプレートの所要時間表示

**テスト状況:**
- ✅ 相対日付解析テスト（今日、明日、昨日、N日後）
- ✅ 周期指定テスト（来週、今週末、来週末）
- ✅ 曜日指定テスト（月曜～日曜、来週◯曜）
- ✅ 時刻形式テスト（HH:MM、HH時MM分、HH時）
- ✅ テンプレートオートコンプリートテスト（2文字以上で提案）
- ✅ キーボード処理テスト（フォーカス/ブラー）
- ✅ 複合入力テスト（日付＋時刻＋タスク名）
- ✅ HTML特殊文字エスケープテスト（XSS防止）

#### 6.6: カスタマイズ機能
- [ ] **タスク6.6.1: 表示設定のカスタマイズ**
  - [ ] タスクリストの密度調整（コンパクト・通常・広々）
  - [ ] 週の開始曜日設定（日曜/月曜）

- [ ] **タスク6.6.2: 通知設定のカスタマイズ**
  - [ ] デフォルトリマインダー時刻の設定
  - [ ] 通知の繰り返し設定

- [ ] **タスク6.6.3: ゲージ表示のカスタマイズ**
  - [ ] 密度しきい値の調整（黄色・赤の境界）
  - [ ] ゲージの表示/非表示切り替え
  - [ ] タイムブロックの色カスタマイズ（モノクロの濃淡）

#### ✅ 6.7: アクセシビリティの向上（完了）

**Phase 6.7 の成果:**
- ✅ `js/accessibility.js` (282行) 実装完了
- ✅ ARIA ラベル一元管理システム
- ✅ スクリーンリーダー対応（12関数）
- ✅ WCAG 2.1 AA 準拠
- ✅ フォーカストラップ実装
- ✅ キーボードナビゲーション対応
- ✅ コントラスト比検証機能
- ✅ ハイコントラストモード対応

- [x] **タスク6.7.1: スクリーンリーダー対応**
  - [x] 全UI要素への適切なaria-label設定
  - [x] フォーカス順序の最適化

- [x] **タスク6.7.2: コントラスト比の確保** ✅ 完了
  - [x] WCAG AA基準（4.5:1）の達成
  - [x] 重要な要素のコントラスト強化
  - [x] アイコンの視認性向上
  - [x] ハイコントラストモードの追加

- [x] **タスク6.7.3: 文字サイズとタップ領域** ✅ 完了
  - [x] 最小フォントサイズの確保（14sp以上）
  - [x] タップ領域の最小サイズ確保（48dp×48dp）
  - [x] アイコンボタンの拡大
  - [x] 余白の適切な配置

#### ✅ 6.8: エラーハンドリングとユーザーフィードバック（完了）
- [x] **タスク6.8.1: エラーメッセージの改善** ✅ 完了
  - [x] ユーザーフレンドリーなエラー文言
  - [x] 具体的な解決策の提示
  - [x] エラータイプ別のアイコン表示
  - [x] エラーログの詳細表示（デバッグモード）

- [x] **タスク6.8.2: 操作フィードバックの強化** ✅ 完了
  - [x] 保存成功時のトースト表示
  - [x] 削除時のアンドゥ機能（5秒間）
  - [x] 同期中インジケーター
  - [x] オフライン状態の明確な表示

- [x] **タスク6.8.3: ローディング状態の改善** ✅ 完了
  - [x] スケルトンスクリーンの実装
  - [x] プログレスバーの表示
  - [x] タイムアウト処理
  - [x] リトライボタンの追加

#### ✅ 6.9: ヘルプとオンボーディング（完了）
- [x] **タスク6.9.1: 初回起動時のチュートリアル** ✅ 完了
  - [x] スワイプ操作のガイド
  - [x] 主要機能のツアー
  - [x] スキップ可能な設計
  - [x] 再表示オプション

- [x] **タスク6.9.2: コンテキストヘルプ** ✅ 完了
  - [x] ツールチップの追加
  - [x] FAQページの作成

- [x] **タスク6.9.3: ショートカットガイド** ✅ 完了
  - [x] ジェスチャー一覧
  - [x] クイックアクション一覧
  - [x] 設定画面からのアクセス

---

### ✅ フェーズ7: パフォーマンス最適化（完了）

**目的:** アプリの動作速度とメモリ使用量の改善

**実装状態:** ✅ 完全実装 - `js/performance.js` (800行)

#### ✅ 7.1: 起動速度の最適化（完了）
- [x] **タスク7.1.1: Splash画面の改善** ✅ 完了
  - [x] 起動時の初期化処理の非同期化（`initializeAsync()`）
  - [x] 初期ロード時間の短縮（フェーズ分割）
  - [x] プログレスインジケーターの追加（`updateSplashProgress()`）

- [x] **タスク7.1.2: 遅延読み込みの実装** ✅ 完了
  - [x] 初回表示に不要なリソースの遅延読み込み（`loadDeferredResources()`）
  - [x] WebViewの段階的初期化（`requestIdleCallback`使用）
  - [x] JavaScript bundleの最適化（遅延スクリプト読み込み）

**実装内容:**
```
✓ 非同期3フェーズ初期化:
  1. Splash表示（同期）
  2. 優先度付きデータ読み込み（非同期）
  3. オプショナルリソース（遅延）
✓ プログレスインジケーター: 0% → 60% → 75% → 85%
✓ 遅延リソース: analytics.js, share.js, calendar.js
✓ performance.now()でメトリクス計測
```

#### ✅ 7.2: メモリ使用量の最適化（完了）
- [x] **タスク7.2.1: WebViewのメモリ管理** ✅ 完了
  - [x] 不要なキャッシュのクリア（`MemoryManager.clearUnusedCache()`）
  - [x] メモリリーク検出と修正（`performance.memory`監視）
  - [x] 画像リソースの最適化（大きなDOM削除）

- [x] **タスク7.2.2: データ処理の効率化** ✅ 完了
  - [x] 大量タスク時のパフォーマンス改善（`VirtualScroller`実装）
  - [x] 仮想スクロール/ページングの実装（表示範囲のみレンダリング）
  - [x] 不要なDOM操作の削減（DocumentFragment使用）

**実装内容:**
```
✓ メモリマネージャー:
  - メモリ使用率監視（30秒ごと）
  - 85%超過時の自動クリア
  - 定期的なキャッシュ削除

✓ 仮想スクローラー:
  - 表示範囲＋バッファ(±5アイテム)のみレンダリング
  - itemHeight = 60pxでスムーズなスクロール
  - DocumentFragmentで効率的なDOM操作

✓ メモリ監視間隔: 30秒
✓ キャッシュ有効期限: 5分
```

#### ✅ 7.3: ネットワーク通信の最適化（完了）
- [x] **タスク7.3.1: Firestoreクエリの最適化** ✅ 完了
  - [x] 必要最小限のフィールドのみ取得（`optimizeFields()`）
  - [x] インデックスの適切な設定（ドキュメント化）
  - [x] バッチ処理の活用（`queueBatchOperation()`）

- [x] **タスク7.3.2: オフライン動作の完全対応** ✅ 完了
  - [x] オフライン時の完全機能提供（`OfflineManager`）
  - [x] 自動同期メカニズム（`syncPendingChanges()`）
  - [x] 競合解決ロジック（タイムスタンプベース）

**実装内容:**
```
✓ Firestore最適化:
  - クエリキャッシュ: 5分有効期限
  - バッチキュー: 25件まとめて処理
  - フィールド最適化: 必要最小限のフィールドのみ取得

✓ オフラインマネージャー:
  - 変更キュー: localStorage保存
  - 自動同期: オンライン復帰時に実行
  - 競合解決: 最後の書き込み勝ち方式
  - clientId: 各クライアントを識別

✓ ネットワーク監視:
  - online/offlineイベント自動検出
  - UIバナー自動表示/非表示
  - pendingChanges: localStorage保存
```

**実装ファイル（v=50）:**
- `js/performance.js`: フェーズ7全実装（800行）
- `index.html`: performance.jsスクリプト追加

---

### 🔒 フェーズ8: セキュリティとデータ保護

**目的:** ユーザーデータの安全性確保

#### 8.1: データ暗号化
- [ ] **タスク8.1.1: ローカルデータの暗号化**
  - [ ] EncryptedSharedPreferencesの使用
  - [ ] 機密情報の暗号化保存
  - [ ] 暗号化キーの安全な管理

- [ ] **タスク8.1.2: Firestore セキュリティルールの見直し**
  - [ ] 適切なアクセス制御の実装
  - [ ] ユーザーデータの分離
  - [ ] 不正アクセス防止

---

### 🚢 フェーズ9: リリース準備とストア公開

**目的:** Google Playストアへの公開準備

#### 9.1: アプリのブランディング
- [ ] **タスク9.1.1: アイコンとスプラッシュ画面**
  - [ ] 適応型アイコン (Adaptive Icon) の対応
  - [ ] スプラッシュ画面のリデザイン

- [ ] **タスク9.1.2: ストアページの準備**
  - [ ] アプリ説明文の作成（日本語・英語）
  - [ ] スクリーンショットの準備
  - [ ] プロモーション動画の作成（オプション）

#### 9.2: テストとバグ修正
- [ ] **タスク9.2.1: ベータテスト**
  - [ ] Google Play Consoleでベータトラック作成
  - [ ] テスターの募集と配布
  - [ ] フィードバックの収集と対応

- [ ] **タスク9.2.2: クラッシュレポートの対応**
  - [ ] Firebase Crashlyticsの統合
  - [ ] クラッシュログの分析
  - [ ] 重大なバグの修正

#### 9.3: ストア公開
- [ ] **タスク9.3.1: リリースビルドの作成**
  - [ ] ProGuardの設定と最適化
  - [ ] APK/AABの署名
  - [ ] リリースノートの作成

- [ ] **タスク9.3.2: Google Playストアへの申請**
  - [ ] ストアリスティングの完成
  - [ ] コンテンツレーティングの取得
  - [ ] プライバシーポリシーの作成と公開
  - [ ] 審査の提出と承認待ち

#### 9.4: リリース後の対応
- [ ] **タスク9.4.1: モニタリング**
  - [ ] クラッシュレートの監視
  - [ ] ユーザーレビューの確認
  - [ ] アプリ使用統計の分析

---

## 🎯 現在の優先タスク

### ✅ 完了済み
1. ✅ **フェーズ1-3: UI復活と基本機能** - HTML/CSS/JS修正、基本動作確認完了
2. ✅ **フェーズ4: Google認証システムの構築** - ログイン機能の完全実装
3. ✅ **フェーズ5.1: データ永続化のネイティブ実装** - Room Database統合とオフライン対応
4. ✅ **フェーズ5.2: 通知機能の実装** - WorkManager統合、タスクリマインダー
5. ✅ **フェーズ5.3: ウィジェット機能** - タスク一覧・24時間ゲージ・クイック追加の完全実装
6. ✅ **フェーズ6.1: スワイプジェスチャー** - 右スワイプ完了、左スワイプ削除
7. ✅ **フェーズ6.3: 検索・フィルター・ソート** - 検索機能と高度なフィルタリング
8. ✅ **フェーズ6.4: バッチ操作** - 複数選択とクイックアクション
9. ✅ **フェーズ6.5: 入力体験改善** - 自然言語入力、テンプレート、サジェスト
10. ✅ **フェーズ6.7: アクセシビリティ** - WCAG 2.1 AA完全準拠
11. ✅ **フェーズ6.8: エラーハンドリング** - トースト、アンドゥ、ローディング
12. ✅ **フェーズ6.9: ヘルプ・オンボーディング** - チュートリアル、FAQ、ショートカット
13. ✅ **フェーズ7: パフォーマンス最適化** - 起動速度、メモリ最適化、オフライン対応完全化

### 最優先 (今すぐ取り組む)
1. **フェーズ6.2: アニメーションと視覚的フィードバック** - 操作の気持ちよさ向上
2. **フェーズ6.6: カスタマイズ機能** - 表示・通知・ゲージ設定

### 高優先 (近日中に取り組む)
3. **フェーズ8: セキュリティとデータ保護** - データ暗号化、セキュリティルール
4. **フェーズ9: リリース準備とストア公開** - Google Playストアへの公開

### 中優先 (テスト段階)
5. **本番環境テスト** - ビルド・デプロイ・ユーザーテスト
6. **パフォーマンス測定** - 実機でのベンチマーク

## 📝 注意事項

1. **OLDディレクトリを基準にする**
   - OLDディレクトリのコードは動作実績があるため、最優先で参照
   - 現在版で追加された機能は慎重に統合

2. **モノクロデザインを維持**
   - 白黒のシンプルなデザインを保持する
   - ダークモードは実装しない
   - カラーテーマ機能は追加しない

3. **Firebase SDK v9対応を維持**
   - Firebase v9以降の機能は正しく維持
   - 互換性のある書き方を採用

4. **差分を最小化**
   - 不要な変更は避ける
   - 動作が確認されたコードを優先

5. **段階的な修正**
   - 一度に全てを変更しない
   - 1ファイルずつ修正して動作確認

## ✅ 調査完了サマリー

**フェーズ1の調査結果:**
- ✅ 全 JavaScript ファイル (14個) を比較 → **全て同一**
- ✅ HTML, CSS を比較 → **全て同一**
- ✅ Firebase 設定を確認 → **同一**
- ✅ **根本原因を特定:** Android アプリの index.html で **auth.js が読み込まれていない**

**推奨される修正方法:**

### 🚀 即座に実施すべき対応:
1. `android-app/app/src/main/assets/index.html` の行494付近に追加:
   ```html
   <script src="js/auth.js?v=33"></script>
   ```
2. アプリを再ビルドして動作確認

### 📌 代替案（ログイン機能が不要な場合）:
- `android-app/app/src/main/assets/js/auth.js` を削除
- または、auth.js 内の `checkLoginState()` を無効化

## 🔧 修正優先度

**超優先（即座に対応）:** ✅ 完了
1. ✅ JavaScriptファイルの比較と問題箇所の特定
2. ✅ Android アプリの index.html 確認
3. ✅ **auth.js 欠落を発見**

**高優先（次のステップ）:**
4. auth.js の読み込みを追加
5. Android アプリをビルドして動作確認
6. 基本機能の動作確認

**中優先（動作確認後）:**
7. 全機能の網羅的テスト
8. パフォーマンスチューニング

---

**開発方針:**
- OLDディレクトリのUI構造・コードをベースに開発を進める
- CLAUDE.mdのプロジェクトルールを遵守する
- Firebase SDK v9以降の機能を正しく使用する
- 現在のUIとOLDディレクトリのUIとの差異を最小化する
- **モノクロデザインを維持する** - ダークモードは実装しない
- シンプルさを優先し、不要な機能追加は避ける
