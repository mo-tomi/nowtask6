# フェーズ 6.5: 入力体験の改善 - テストガイド

このドキュメントは、実装された入力体験の改善機能をAndroidアプリで検証するためのテストガイドです。

## 📋 テスト環境

- **対象:** `android-app/app/src/main/assets/`
- **主要ファイル:**
  - `js/input-experience.js` - 自然言語入力、オートコンプリート、絵文字ピッカーの実装
  - `js/events.js` - クイック入力フォームとの統合（lines 382-516改善）
  - `style.css` - UI スタイル（lines 3642-3768）
  - `index.html` - スクリプト読み込み（line 628）

## 🧪 テストケース

### TC-001: 自然言語日付解析 - 相対日付

**テスト内容:** 相対日付の自然言語入力が正しく解析される

**実行手順:**
1. アプリを起動し、クイック入力フィールドを表示
2. 以下のテキストを入力してEnterキーを押す：`明日 買い物`
3. タスク一覧を確認

**期待結果:**
- ✅ タスク名が「買い物」のみに設定される（日付部分が削除される）
- ✅ 期限日が明日に設定される
- ✅ 今日のセクションではなく明日のセクションに表示される

**テストコード（ブラウザコンソール）:**
```javascript
// 手動テスト
const result = parseNaturalDatetime("明日 買い物");
console.log("Result:", result);
// Expected: dueDate は明日の日付、時刻は12:00

const inputResult = processNaturalInput("明日 買い物");
console.log("Input Result:", inputResult);
// Expected: hasDatetime: true, taskTitle: "買い物"
```

---

### TC-002: 自然言語日付解析 - 曜日指定

**テスト内容:** 曜日指定の自然言語入力が正しく解析される

**実行手順:**
1. クイック入力フィールドに `来週月曜 会議準備` を入力してEnter
2. タスク一覧を確認

**期待結果:**
- ✅ タスク名が「会議準備」になる
- ✅ 期限日が来週の月曜日に設定される
- ✅ 来週のセクションに表示される

**テスト用テキスト:**
- `今週末 ランチ` → 土曜日に設定
- `来週末 運動` → 来週の土曜日に設定
- `月曜 コード レビュー` → 今週または来週の月曜日
- `金曜 ドキュメント作成` → 今週または来週の金曜日

---

### TC-003: 自然言語時刻解析

**テスト内容:** 時刻指定の自然言語入力が正しく解析される

**実行手順:**
1. クイック入力フィールドに `明日 14時 メール確認` を入力
2. タスクが作成されたかを確認
3. タスクの開始時刻が14:00に設定されているか確認

**期待結果:**
- ✅ タスク名が「メール確認」になる
- ✅ 期限日が明日に設定される
- ✅ `startTime` が「14:00」に設定される

**テスト用テキスト:**
- `明日 14時30分 買い物` → 14:30
- `3日後 15:45 報告書作成` → 15:45
- `来週月曜 09時 朝礼` → 09:00
- `今週末 18:00 ディナー` → 18:00

---

### TC-004: テンプレートオートコンプリート

**テスト内容:** テンプレートサジェストが入力に応じて表示される

**実行手順:**
1. クイック入力フィールドをタップして焦点を当てる
2. `買` を入力
3. ドロップダウンが表示されるか確認
4. 「買い物」を選択
5. 入力フィールドが「買い物」で埋まるか確認

**期待結果:**
- ✅ 2文字以上入力するとドロップダウンが表示される
- ✅ マッチするテンプレートが表示される（最大5件）
- ✅ テンプレートを選択するとそのテキストが入力される
- ✅ テンプレートに所要時間が表示される場合、その情報も表示される

**テスト用キーワード:**
- `会` → 「会議準備」
- `メ` → 「メール確認」
- `コ` → 「コード レビュー」
- `ラ` → 「ランチ」

---

### TC-005: フォーカス/ブラーイベント処理

**テスト内容:** キーボード表示時の画面調整が正常に動作する

**実行手順:**
1. クイック入力フィールドをタップ（フォーカス）
2. キーボードが表示される
3. クイック入力フォームが自動的にスクロール位置に移動するか確認
4. 他の場所をタップして入力フィールドをブラー
5. オートコンプリートドロップダウンが消える

**期待結果:**
- ✅ フォーカス時に `scrollIntoView()` で画面調整
- ✅ ブラー時にオートコンプリートが非表示になる

---

### TC-006: タスク履歴からの提案

**テスト内容:** 過去に作成したタスク名が履歴として提案される

**実行手順:**
1. 複数のタスクを作成（例：「買い物」「会議準備」「ランチ」）
2. クイック入力の履歴ボタン（⏰）をタップ
3. 作成したタスク名が履歴タグとして表示されるか確認
4. 履歴タグをタップして、そのタスクが即座に作成されるか確認

**期待結果:**
- ✅ 最大10件の履歴が表示される
- ✅ 履歴タグをクリックすると、そのタスク名で新規タスクが作成される
- ✅ 履歴から作成されたタスクは今日の日付で設定される

---

### TC-007: HTML特殊文字のエスケープ

**テスト内容:** 特殊文字を含むテンプレート名が正しくエスケープされる

**実行手順:**
1. クイック入力フィールドに `<script>` を含むテキストを入力
2. 画面上に XSS 攻撃がないか確認

**期待結果:**
- ✅ 特殊文字が HTML エンティティに変換される
- ✅ スクリプトが実行されず、テキストとして表示される

**テスト用テキスト:**
- `<b>太字</b>テスト` → `&lt;b&gt;太字&lt;/b&gt;` として表示
- `"引用"テスト` → `&quot;引用&quot;` として表示

---

### TC-008: 複合入力テスト

**テスト内容:** 日付 + 時刻 + テンプレート名の組み合わせ

**実行手順:**
1. `明日 14時 買い物` を入力してEnter
2. タスクが正しく作成されるか確認
3. タスク名、期限日、開始時刻をすべて確認

**期待結果:**
- ✅ タスク名: 「買い物」
- ✅ 期限日: 明日
- ✅ 開始時刻: 14:00

**追加テストケース:**
- `3日後 09:30 会議準備`
- `来週月曜 15時 ドキュメント作成`
- `今週末 18:00 ランチ`

---

### TC-009: キーボード入力とForm送信の統合

**テスト内容:** Enter キーでのフォーム送信が正しく動作する

**実行手順:**
1. クイック入力フィールドに `明日 14時 テスト` を入力
2. Enter キーを押す
3. フォームが送信されてタスクが作成されるか確認

**期待結果:**
- ✅ `processNaturalInput()` が呼び出される
- ✅ 日付と時刻が正しく解析される
- ✅ タスク名から日時部分が削除される
- ✅ タスクがデータベースに保存される
- ✅ 入力フィールドがクリアされる
- ✅ タスク一覧が更新されて新しいタスクが表示される

---

### TC-010: 日付パネルとの競合テスト

**テスト内容:** 手動で日付パネルで日付を設定した場合と、自然言語入力の競合

**実行手順:**
1. クイック入力フィールドに `明日 買い物` を入力
2. 日付パネルボタン（📅）をタップ
3. 別の日付を選択（例：今週末）
4. Enter で送信

**期待結果:**
- ✅ 自然言語解析が優先される（または手動日付が優先される）
- ✅ 結果がユーザーの意図と一致する
- ✅ データが正しく保存される

---

## 🎯 手動テストの実行手順

### ステップ 1: アプリの起動と初期化確認

```bash
# ブラウザコンソール（F12を開いて実行）
console.log('Input experience enhancement initialized');
// 上記が表示されたら初期化成功
```

### ステップ 2: 関数の存在確認

```javascript
// コンソールで以下を実行して関数が利用可能か確認
console.log(typeof parseNaturalDatetime); // "function"
console.log(typeof processNaturalInput); // "function"
console.log(typeof getTemplateCompletions); // "function"
console.log(typeof updateAutocompleteUI); // "function"
console.log(typeof insertEmoji); // "function"
```

### ステップ 3: 自然言語解析のテスト

```javascript
// 日付解析
const test1 = parseNaturalDatetime("明日 14時");
console.log("Parse result:", test1);

// 入力処理
const test2 = processNaturalInput("明日 14時 買い物");
console.log("Process result:", test2);

// テンプレート補完
const test3 = getTemplateCompletions("買");
console.log("Template suggestions:", test3);
```

### ステップ 4: UIテスト

```javascript
// オートコンプリート UI の更新
updateAutocompleteUI("買");

// 絵文字ピッカーの表示
showEmojiPicker();
```

---

## ✅ チェックリスト

### 機能の完全性確認

- [ ] 自然言語日付解析が全パターンで動作している
  - [ ] 相対日付（今日、明日、昨日、N日後）
  - [ ] 周期指定（来週、今週末、来週末）
  - [ ] 曜日指定（月曜、火曜、...）

- [ ] 時刻解析が全形式で動作している
  - [ ] `HH:MM` 形式（14:30）
  - [ ] `HH時MM分` 形式（14時30分）
  - [ ] `HH時` 形式（14時）

- [ ] テンプレートオートコンプリートが動作している
  - [ ] 2文字以上で提案が表示される
  - [ ] 最大5件まで表示される
  - [ ] テンプレート選択で入力が更新される

- [ ] キーボード処理が正常に動作している
  - [ ] フォーカス時に画面がスクロール
  - [ ] ブラー時にオートコンプリートが非表示

- [ ] フォーム送信統合が正常に動作している
  - [ ] 自然言語入力が解析される
  - [ ] 日付がタスクに正しく設定される
  - [ ] 時刻がタスクに正しく設定される
  - [ ] タスク名から日時部分が削除される

### パフォーマンス確認

- [ ] クイック入力が遅延なく動作
- [ ] オートコンプリートが素早く表示
- [ ] 大量のタスク作成時のパフォーマンス問題がない

### ブラウザ互換性確認

- [ ] Google Chrome で動作
- [ ] Firefox で動作
- [ ] Safari（iOS）で動作
- [ ] Android WebView で動作

### バグ確認

- [ ] 特殊文字が正しくエスケープされる
- [ ] 無効な日時入力がハンドルされる
- [ ] ネットワークエラー時の処理が正常

---

## 🔧 トラブルシューティング

### オートコンプリートが表示されない

**原因:** `quick-input-wrapper` 要素が見つからない

**対策:**
```javascript
// コンソールで確認
const wrapper = document.querySelector('.quick-input-wrapper');
console.log('Wrapper found:', wrapper !== null);
```

### 日付が解析されない

**原因:** `processNaturalInput()` が呼び出されていない

**対策:**
```javascript
// コンソールでデバッグ
const result = processNaturalInput("明日 14時 買い物");
console.log("Result:", result);
console.log("Has datetime:", result.hasDatetime);
```

### テンプレートが常に空

**原因:** `TEMPLATE_SNIPPETS` が定義されていない

**対策:**
```javascript
console.log("Templates:", TEMPLATE_SNIPPETS);
console.log("Count:", TEMPLATE_SNIPPETS.length);
```

---

## 📊 実装統計

| 項目 | 数値 |
|------|------|
| 実装行数 | 403 |
| 関数数 | 12 |
| サポートされた日付パターン | 11 |
| サポートされた時刻形式 | 3 |
| テンプレート数 | 10 |
| 絵文字数 | 20 |
| CSS 行数 | 130+ |

---

## 📝 改善提案

### 今後の拡張案

1. **音声入力:** 音声で日時入力を受け取る
2. **カスタムテンプレート:** ユーザーが自分のテンプレートを作成・保存
3. **複数言語対応:** 英語や他の言語のサポート
4. **スマート提案:** AI を使った優先度提案
5. **カレンダー統合:** ドラッグ&ドロップでスケジュール設定

---

## 📞 サポート

質問や問題が発生した場合は、以下の情報を含めて報告してください：

- ブラウザ / Android WebView バージョン
- エラーメッセージ（あれば）
- 実行したテストケース
- 期待された動作
- 実際の動作

---

**最終更新:** 2025年10月16日
**バージョン:** 1.0 - フェーズ6.5入力体験改善
**実装状態:** ✅ 完了
